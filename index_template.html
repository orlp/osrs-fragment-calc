<html>
  <head>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="style.css">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <body>
  

<div class="main">

  <div class="mainleft">
    <h3>Fragment Set Calculator</h3>
    <p>
    For each desired set effect or individual fragment, indicate your preference
    on the right. <tt>!</tt> is never, <tt>&</tt> is always. Using <tt>1</tt>, <tt>2</tt> and
    <tt>3</tt> you can indicate soft preferences, with "<tt>-</tt>" indicating a preference of -1. At most 25 results are shown, in order
    of preference, with ties broken by fewest fragments required.</p>

    <p><label for="numfrags">Fragments:</label> <input type="number" step="1" min="1" max="7" value="7" id="maxfrags"></input>
    <input type="button" id="calculate" value="Calculate"></input>
    <input type="button" id="reset" value="Reset"></input></p>

    <h3>Results:</h3>
    <div id="results">Please select a preference and click calculate.</div>
  </div>

<form id="calcinput">
<div class="sets">
SETEFFECTSHERE
</div>

<div class="tablegridwrapper">
TABLEGRIDHERE
</div>
</form>

</div> <!-- main -->

<!-- Note the usage of `type=module` here as this is an ES6 module -->
<script type="module">
    import init, { init_panic_hook, compute_combinations } from './pkg/fragments.js';

    let fragsets = FRAGSETSHERE;

    let icon = function(name) {
        let icon_name = name.replace("Last Recall", "Last Recall (Shattered Relics)").replaceAll(" ", "_");
        let url = "https://oldschool.runescape.wiki/images/" + encodeURIComponent(icon_name) + ".png";
        let title = name;
        if (fragsets[name] != null) {
            title = fragsets[name].join(" / ");
        }
        let img = '<img class="icon" src="' + url + '" title="' + title + '">';
        return img;
    }
    
    async function run() {
        await init();
        init_panic_hook();

        let should_show_level = {};
        should_show_level["Absolute Unit"] = true;
        should_show_level["Chain Magic"] = true;
        should_show_level["Double Tap"] = true;
        should_show_level["Drakan's Touch"] = true;
        should_show_level["Greedy Gatherer"] = true;
        should_show_level["Knife's Edge"] = true;
        should_show_level["Personal Banker"] = true;
        should_show_level["Twin Strikes"] = true;
        
        // And afterwards we can use all the functionality defined in wasm.
        // console.log(compute_combinations);
        $("#calculate").click(function() {
            let frag_weights = {};
            let set_effect_weights = [];
            
            let num_mandatory = 0;
            
            $(':radio:checked').each(function(e) {
                let name = this.getAttribute("data-name");
                let lvl = this.getAttribute("data-lvl");
                let weight = parseInt(this.value);
                if (weight != 0) {
                    if (weight >= 1000) {
                        num_mandatory += 1;
                    }
                    if (lvl !== null) {
                        set_effect_weights.push([name, parseInt(lvl), weight]);
                    } else {
                        frag_weights[name] = weight;
                    }
                }
                
            });
            let query = JSON.stringify({
                "max_fragments": parseInt(document.getElementById("maxfrags").value),
                "set_effect_weights": set_effect_weights,
                "frag_weights": frag_weights,
                "max_results": 25,
            });
            let result = JSON.parse(compute_combinations(query));
            
            let resultdiv = document.getElementById("results");
            resultdiv.innerHTML = '';
            let num_filtered = 0;
            for (let combo of result["result"]) {
                // Filter missed mandatory requirements (this also takes care
                // of highly negative forbidden combos).
                if (combo["score"] < num_mandatory * 1000 - 100) {
                    continue;
                }
                num_filtered += 1;

                let display = ["<h5>Soft preference score: " + (combo["score"] - num_mandatory * 1000) + "</h5>"];
                display.push("<ul>");
                for (let frag of combo["used_fragments"]) {
                    display.push("<li>");
                    display.push(icon(frag) + " " + frag);
                    display.push("</li>");
                }
                display.push("</ul>");
                
                let effects = [];
                for (let set of combo["activated_set_effects"]) {
                    if (should_show_level[set[0]]) {
                        effects.push(icon(set[0]) + " (" + set[1] + ")");
                    } else {
                        effects.push(icon(set[0]));
                    }
                }
                if (effects.length > 0) {
                    display.push("Set effects: " + effects.join(", "));
                } else {
                    display.push("Set effects: none.");
                }

                resultdiv.insertAdjacentHTML("beforeend", display.join(""));
            }

            if (num_filtered === 0) {
                resultdiv.innerHTML = 'No results.';
            }
        
            tippy('#results [title]', {
  content(reference) {
    const title = reference.getAttribute('title');
    reference.removeAttribute('title');
    return title;
  },
});
        });

        $("#reset").click(function() {
            document.getElementById("calcinput").reset();
        });
    }
    
    run();
</script>

<script
src="https://code.jquery.com/jquery-3.6.0.min.js"
integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
crossorigin="anonymous"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<script type="text/javascript">
    $(function(){
        $('label').bind('touchstart mousedown', function() {
            var target = $('#' + $(this).attr("for"));
            target.prop("checked", !target.prop("checked"));
        }).bind('click touchend', function(e) {
            e.preventDefault();
        });

        tippy('[title]', {
  content(reference) {
    const title = reference.getAttribute('title');
    reference.removeAttribute('title');
    return title;
  },
});
    });
</script>
</body>
</html>
